{% extends 'base.html' %}

{% block title %}Live Studio | MindFeed{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <aside class="sidebar">
        <h3>Menu</h3>
        <nav>
            <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
            <a href="{{ url_for('upload_news_page') }}" class="nav-link">Read Newspaper</a>
            <a href="{{ url_for('live_news') }}" class="nav-link active">Live Broadcast üéôÔ∏è</a>
            <a href="{{ url_for('history') }}" class="nav-link">Archive</a>
            <a href="{{ url_for('auth.preferences') }}" class="nav-link">Preferences</a>
        </nav>
    </aside>

    <main class="main-content">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h1>üéôÔ∏è Live News Studio</h1>
                <p style="color: var(--text-muted);">AI-Powered Personal Radio</p>
            </div>
            <a href="{{ url_for('dashboard') }}" class="btn-sm btn-outline">Exit</a>
        </header>

        <div class="card" style="max-width: 800px; margin: 0 auto; padding: 2rem; text-align: center;">
            
            <div style="margin-bottom: 20px;">
                <span class="status-badge" id="status" style="background: #e8f5e9; color: #27ae60; padding: 5px 15px; border-radius: 20px; font-weight: bold;">
                    Ready to Air
                </span>
            </div>

            <div id="teleprompter" style="
                background: #1a1a1a; 
                color: #e0e0e0; 
                padding: 30px; 
                border-radius: 12px; 
                font-family: monospace; 
                font-size: 1.2rem; 
                line-height: 1.6; 
                min-height: 150px; 
                margin: 20px 0;
                box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
                border: 1px solid #333;">
                Click 'Start Broadcast' to connect to the studio...
            </div>

            <div class="controls" style="margin-top: 30px;">
                <button id="startBtn" class="btn-sm" style="background-color: #e74c3c; border: none; font-size: 1.1rem; padding: 12px 30px;">
                    üî¥ Go Live
                </button>
                <button id="stopBtn" class="btn-sm btn-outline" style="margin-left: 10px; display: none;">
                    ‚èπ Stop
                </button>
            </div>
            
            <p style="margin-top: 20px; font-size: 0.8rem; color: #999;">
                Note: News sourced from Google News. Trustworthy and reliable.
            </p>
        </div>
    </main>
</div>

<script>
    // --- CONFIG ---
    const AUDIO_INTRO = "/static/media/newsIntro.mp3";
    const AUDIO_HEAD  = "/static/media/newsHead.mp3";
    const AUDIO_DETAIL = "/static/media/newsDetails.mp3";

    const bgmIntro = new Audio(AUDIO_INTRO);
    const bgmHead = new Audio(AUDIO_HEAD);
    const bgmDetail = new Audio(AUDIO_DETAIL);
    bgmHead.loop = true;
    bgmDetail.loop = true;

    let isRunning = false;
    let currentLang = 'ml'; // Default to Malayalam
    
    // UI Elements
    const prompter = document.getElementById("teleprompter");
    const statusBadge = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    
    // TTS Setup
    const synth = window.speechSynthesis;
    let voices = [];
    
    function loadVoices() {
        voices = synth.getVoices();
    }
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    }

    // --- TEXT ASSETS (Language Specific) ---
    const SCRIPTS = {
        'ml': {
            intro: "‡¥®‡¥Æ‡¥∏‡µç‡¥ï‡¥æ‡¥∞‡¥Ç, ‡¥™‡µç‡¥∞‡¥ß‡¥æ‡¥® ‡¥µ‡¥æ‡µº‡¥§‡µç‡¥§‡¥ï‡µæ...",
            details: "‡¥µ‡¥æ‡µº‡¥§‡µç‡¥§‡¥ï‡µæ ‡¥µ‡¥ø‡¥∂‡¥¶‡¥Æ‡¥æ‡¥Ø‡¥ø...",
            outro: "‡¥µ‡¥æ‡µº‡¥§‡µç‡¥§‡¥ï‡µæ ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£‡¥Æ‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ. ‡¥®‡¥®‡µç‡¥¶‡¥ø, ‡¥®‡¥Æ‡¥∏‡µç‡¥ï‡¥æ‡¥∞‡¥Ç.",
            voiceCode: 'ml-IN'
        },
        'en': {
            intro: "Hello, bringing you the top stories of the hour...",
            details: "Here are the details...",
            outro: "That concludes our bulletin. Thank you for listening.",
            voiceCode: 'en-US' // Or en-GB
        }
    };

    // --- HELPER: Detect Language from Content ---
    function detectLanguage(text) {
        // Check for Malayalam Unicode range (0D00‚Äì0D7F)
        const malayalamRegex = /[\u0D00-\u0D7F]/;
        return malayalamRegex.test(text) ? 'ml' : 'en';
    }

    // --- FETCH NEWS ---
    async function fetchNews() {
        // 1. CHECK IF REPLAY MODE
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'replay') {
            statusBadge.innerText = "Loading Replay Data...";
            statusBadge.style.color = "#2980b9"; 
            statusBadge.style.background = "#d6eaf8";
            
            const savedData = localStorage.getItem('replayData');
            if (savedData) {
                return JSON.parse(savedData);
            }
        }

        // 2. LIVE MODE
        statusBadge.innerText = "Connecting to Latest News...";
        statusBadge.style.color = "#d35400";
        statusBadge.style.background = "#fdebd0";
        
        try {
            const response = await fetch('/api/process-news', { method: 'POST' });
            const data = await response.json();
            return (data.success && data.news_data) ? data.news_data : null;
        } catch (e) {
            console.error(e);
            return null;
        }
    }

    function unlockAudio() {
        [bgmIntro, bgmHead, bgmDetail].forEach(a => { a.play().then(() => a.pause()).catch(() => {}); });
    }

    async function startBroadcast() {
        if (isRunning) return;
        
        // UI Updates
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
        unlockAudio();
        loadVoices();

        const newsData = await fetchNews();
        
        if (!newsData || !newsData.headlines || newsData.headlines.length === 0) {
            prompter.innerText = "Signal Lost. No news available.";
            stopImmediately();
            return;
        }

        // --- üß† AUTO-DETECT LANGUAGE ---
        // We check the first headline to decide the language mode
        const sampleText = newsData.headlines[0];
        currentLang = detectLanguage(sampleText);
        console.log("Detected Language Mode:", currentLang);

        // Update Badge
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'replay') {
             statusBadge.innerText = "REPLAYING ARCHIVE";
             statusBadge.style.background = "#8e44ad"; 
        } else {
             statusBadge.innerText = "ON AIR";
             statusBadge.style.background = "#e74c3c";
        }
        statusBadge.style.color = "#fff";

        isRunning = true;
        const script = SCRIPTS[currentLang];

        try {
            bgmHead.volume = 0.1;
            bgmDetail.volume = 0.1;

            // 1. Intro
            updatePrompter(script.intro);
            await speak(script.intro);
            await playAudioUntilEnd(bgmIntro);

            // 2. Headlines
            updatePrompter("Headlines...");
            bgmHead.currentTime = 0;
            bgmHead.play();

            for (let line of newsData.headlines) {
                if (!isRunning) return;
                updatePrompter(line);
                await speak(line);
                await wait(600);
            }
            bgmHead.pause();

            // 3. Details
            updatePrompter(script.details);
            await speak(script.details);
            
            bgmDetail.currentTime = 0;
            bgmDetail.volume = 0;
            bgmDetail.play();
            fadeIn(bgmDetail, 0.1);
            await wait(1000);

            for (let line of newsData.details) {
                if (!isRunning) return;
                updatePrompter(line);
                await speak(line);
                await wait(800);
            }

            // 4. Outro
            updatePrompter(script.outro);
            await speak(script.outro);
            fadeOut(bgmDetail);
            await playAudioUntilEnd(bgmIntro);

            stopImmediately();

        } catch (err) {
            console.log(err);
            stopImmediately();
        }
    }

    function updatePrompter(text) {
        prompter.innerText = text;
        prompter.style.borderLeft = "5px solid #27ae60"; 
    }

    // --- SMART TTS FUNCTION ---
    function speak(text) {
        return new Promise(resolve => {
            if (!isRunning) { resolve(); return; }
            synth.cancel();
            
            const utter = new SpeechSynthesisUtterance(text);
            const script = SCRIPTS[currentLang];
            
            utter.lang = script.voiceCode;
            
            // Try to find a matching voice
            const matchingVoice = voices.find(v => v.lang.includes(script.voiceCode.split('-')[0]));
            if(matchingVoice) utter.voice = matchingVoice;

            utter.rate = 0.9;
            utter.onend = resolve;
            utter.onerror = resolve;
            synth.speak(utter);
        });
    }

    function playAudioUntilEnd(audio) {
        return new Promise(resolve => {
            if (!isRunning) { resolve(); return; }
            audio.currentTime = 0;
            audio.play().catch(() => resolve());
            audio.onended = resolve;
        });
    }
    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
    function fadeIn(a, max) {
        let v = 0; a.volume = 0;
        let i = setInterval(() => { if(v<max) { v+=0.01; a.volume=v; } else clearInterval(i); }, 100);
    }
    function fadeOut(a) {
        let i = setInterval(() => { if(a.volume>0.01) a.volume-=0.01; else { clearInterval(i); a.pause(); } }, 100);
    }
    function stopImmediately() {
        isRunning = false;
        synth.cancel();
        bgmIntro.pause(); bgmHead.pause(); bgmDetail.pause();
        
        statusBadge.innerText = "Offline";
        statusBadge.style.background = "#95a5a6";
        startBtn.style.display = "inline-block";
        stopBtn.style.display = "none";
        prompter.style.borderLeft = "none";
    }

    startBtn.addEventListener('click', startBroadcast);
    stopBtn.addEventListener('click', stopImmediately);
</script>
{% endblock %}
